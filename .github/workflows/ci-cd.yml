deploy:
  needs: test
  runs-on: ubuntu-latest
  steps:
    - uses: actions/checkout@v4

    - name: Prepare SSH
      run: |
        mkdir -p $GITHUB_WORKSPACE/ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > $GITHUB_WORKSPACE/ssh/id_rsa
        chmod 600 $GITHUB_WORKSPACE/ssh/id_rsa
        ssh-keyscan -H "${{ secrets.REMOTE_HOST }}" >> $GITHUB_WORKSPACE/ssh/known_hosts
      shell: bash

    - name: Install Ansible
      run: |
        sudo apt update
        sudo apt install -y ansible
      shell: bash

    - name: Run Ansible Playbook
      env:
        GIT_REF: ${{ github.ref_name }}
        ANSIBLE_HOST_KEY_CHECKING: "False"
      run: |
        cd ansible
        ansible-playbook playbooks/deploy.yml \
          -i inventories/production.yml \
          -u ${{ secrets.REMOTE_USER }} \
          --private-key $GITHUB_WORKSPACE/ssh/id_rsa
      shell: bash
